<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

/* =======================
   FIREBASE SETUP
======================= */
const firebaseConfig = {
    databaseURL: "https://lilguys-ae7fe-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =======================
   GAME STATE
======================= */
let player = null;
let password = '';
let selectedAnimal = '';
let gameInterval = null;

/* =======================
   IMAGES
======================= */
const animalImages = {
    cat: { alive: "cat_alive.png", dead: "cat_dead.png" },
    dog: { alive: "dog_alive.png", dead: "dog_dead.png" },
    bunny: { alive: "bunny_alive.png", dead: "bunny_dead.png" },
    squirrel: { alive: "squirrel_alive.png", dead: "squirrel_dead.png" },
    manatee: { alive: "manatee_alive.png", dead: "manatee_dead.png" }
};

/* =======================
   EVENT LISTENERS
======================= */
document.getElementById('startBtn').addEventListener('click', login);
document.getElementById('confirmAnimalBtn').addEventListener('click', confirmAnimal);
document.getElementById('feedBtn').addEventListener('click', feed);
document.getElementById('waterBtn').addEventListener('click', giveWater);
document.getElementById('upgradeFoodBtn').addEventListener('click', () => upgradeGenerator('food'));
document.getElementById('upgradeWaterBtn').addEventListener('click', () => upgradeGenerator('water'));
document.getElementById('tryAgainBtn').addEventListener('click', resetGame);

document.querySelectorAll('.animal-select img').forEach(img => {
    img.addEventListener('click', () => chooseAnimal(img.dataset.animal, img));
});

/* =======================
   LOGIN / LOAD
======================= */
async function login() {
    password = document.getElementById('passwordInput').value.trim();
    if (!password) return alert("Enter a password");

    const blocked = await get(ref(db, 'blockedPasswords/' + password));
    if (blocked.exists()) return alert("This password has already been used.");

    const snap = await get(ref(db, 'players/' + password));
    if (snap.exists()) {
        player = snap.val();
        if (!player.lastUpdate) player.lastUpdate = Date.now();
        if (!player.startTime) player.startTime = Date.now();
    } else {
        player = {
            animal: null,
            nickname: '',
            hunger: 100,
            thirst: 100,
            health: 100,
            food: 0,
            water: 0,
            foodGeneratorLevel: 0,
            waterGeneratorLevel: 0,
            lastUpdate: Date.now(),
            startTime: Date.now()
        };
    }

    if (!player.animal) {
        document.getElementById('animalChoice').style.display = 'block';
    } else {
        startGame();
    }
}

/* =======================
   ANIMAL SELECTION
======================= */
function chooseAnimal(animal, img) {
    selectedAnimal = animal;
    document.querySelectorAll('.animal-select img').forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
}

function confirmAnimal() {
    const name = document.getElementById('nicknameInput').value.trim();
    if (!selectedAnimal || !name) return alert("Pick an animal and name it");

    player.animal = selectedAnimal;
    player.nickname = name;
    player.startTime = Date.now();
    savePlayer();

    document.getElementById('animalChoice').style.display = 'none';
    startGame();
}

/* =======================
   GAME START
======================= */
function startGame() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    document.getElementById('animalName').innerText = `${player.nickname} (${player.animal.toUpperCase()})`;
    document.getElementById('animalImg').src = animalImages[player.animal].alive;

    if (gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(gameTick, 1000);
}

/* =======================
   CORE GAME LOOP
======================= */
function gameTick() {
    const now = Date.now();
    const delta = (now - player.lastUpdate) / 1000;

    /* --- Hunger & Thirst Decay --- */
    player.hunger -= delta * 1;      // 1/sec
    player.thirst -= delta * 1.5;    // 1.5/sec

    if (player.hunger < 0) player.hunger = 0;
    if (player.thirst < 0) player.thirst = 0;

    /* --- Health Decay --- */
    if (player.hunger === 0 && player.thirst === 0) {
        player.health -= delta * 6;  // VERY fast
    } else if (player.hunger === 0 || player.thirst === 0) {
        player.health -= delta * 1;
    }

    if (player.health < 0) player.health = 0;

    /* --- Generator Production --- */
    player.food += delta * (0.5 + player.foodGeneratorLevel * 0.35);
    player.water += delta * (0.6 + player.waterGeneratorLevel * 0.35);

    player.lastUpdate = now;
    savePlayer();

    /* --- UI Update --- */
    document.getElementById('hungerBar').style.width = player.hunger + '%';
    document.getElementById('thirstBar').style.width = player.thirst + '%';
    document.getElementById('healthBar').style.width = player.health + '%';
    document.getElementById('foodCount').innerText = Math.floor(player.food);
    document.getElementById('waterCount').innerText = Math.floor(player.water);

    if (player.health <= 0) {
        clearInterval(gameInterval);
        document.getElementById('animalImg').src = animalImages[player.animal].dead;
        endGame();
    }
}

/* =======================
   PLAYER ACTIONS
======================= */
function feed() {
    if (player.food >= 1) {
        player.food -= 1;
        player.hunger += 20;
        if (player.hunger > 100) player.hunger = 100;
    }
}

function giveWater() {
    if (player.water >= 1) {
        player.water -= 1;
        player.thirst += 20;
        if (player.thirst > 100) player.thirst = 100;
    }
}

function upgradeGenerator(type) {
    if (type === 'food') {
        if (player.water >= 65) {
            player.water -= 65;
            player.foodGeneratorLevel += 1;
        }
    }

    if (type === 'water') {
        if (player.food >= 75) {
            player.food -= 75;
            player.waterGeneratorLevel += 1;
        }
    }
}

/* =======================
   SAVE / END / RESET
======================= */
function savePlayer() {
    set(ref(db, 'players/' + password), player);
}

async function endGame() {
    await set(ref(db, 'leaderboard/' + password), {
        nickname: player.nickname,
        survivalTime: Date.now() - player.startTime
    });
    await set(ref(db, 'blockedPasswords/' + password), true);

    document.getElementById('gameControls').style.display = 'none';
    document.getElementById('tryAgainBtn').style.display = 'inline-block';
}

function resetGame() {
    player = null;
    password = '';
    selectedAnimal = '';

    document.getElementById('login').style.display = 'block';
    document.getElementById('game').style.display = 'none';
    document.getElementById('animalChoice').style.display = 'none';
    document.getElementById('passwordInput').value = '';
    document.getElementById('nicknameInput').value = '';
}

/* =======================
   LEADERBOARD
======================= */
function updateLeaderboard() {
    get(ref(db, 'leaderboard/')).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;

        const sorted = Object.values(data).sort((a,b) => b.survivalTime - a.survivalTime);
        let html = '<ol>';
        sorted.forEach(e => {
            const m = Math.floor(e.survivalTime / 60000);
            const s = Math.floor((e.survivalTime % 60000) / 1000);
            html += `<li>${e.nickname} - ${m}m ${s}s</li>`;
        });
        html += '</ol>';
        document.getElementById('leaderboard').innerHTML = html;
    });
}

updateLeaderboard();
</script>
